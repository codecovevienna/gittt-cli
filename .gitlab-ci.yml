image: node:10.14.1

stages:
  - lint
  - test
  - build
  
cache:
  paths:
    - node_modules
    - ${PKG_CACHE_PATH}

variables:
  PKG_CACHE_PATH: ./pkg-cache
  
lint:
  tags:
    - docker
    - codecove
  stage: lint
  script:
    - npm install
    - npm run lint
  except:
    - tags
  
test:
  tags:
    - docker
    - codecove
  stage: test
  script:
    - npm install
    - npm run test:ci
  except:
    - tags

build_latest:
  tags:
    - docker
    - codecove
  stage: build
  script:
    # Install packages
    - npm install -g pkg
    - npm install
    # Compile ts into js
    - ./node_modules/.bin/tsc
    - cp package.json dist
    # Compile package for various systems
    - pkg -t node10-linux-x64,node10-macos-x64,node10-win-x64 dist/index.js --output gittt-${CI_COMMIT_SHORT_SHA}
  artifacts:
    paths:
      - gittt-*
  only:
    - master
    - GITTT-51-Release-management-for-cli

build_tag:
  tags:
    - docker
    - codecove
  stage: build
  script:
    # Install packages
    - npm install -g pkg
    - npm install
    # Compile ts into js
    - ./node_modules/.bin/tsc
    - cp package.json dist
    # Compile package for various systems
    - pkg -t node10-linux-x64,node10-macos-x64,node10-win-x64 dist/index.js --output gittt-${CI_COMMIT_TAG}
  artifacts:
    paths:
      - gittt-*
  only:
    - tags